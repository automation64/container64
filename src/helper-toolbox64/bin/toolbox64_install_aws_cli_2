#!/usr/bin/env bash

# shellcheck disable=SC1091
source "/toolbox64.env" || exit $?
# shellcheck source=SCRIPTDIR/../../loader/bashlib64.bash disable=SC2154
source "$TOOLBOX64_BASHLIB64" || exit $?

#
# Functions
#

tb64_aws2_provision() {
  local package_installer='aws'
  local package_installer_bin='aws/install'
  local package_source='awscli-exe-linux-x86_64.zip'
  local package_url='https://awscli.amazonaws.com'
  local aws_mode='0755'
  local aws_root='/opt/aws'
  local aws_bin='/opt/aws/bin'
  local aws_cli='/opt/aws/bin/aws'
  local aws_versions='/opt/aws/versions'

  bl64_msg_show_task 'download application'
  # shellcheck disable=SC2154
  package_installer_bin="${TOOLBOX64_TMP}/${package_installer_bin}"
  bl64_rxtx_web_get_file "${package_url}/${package_source}" "${TOOLBOX64_TMP}/${package_source}" &&
    bl64_arc_open_zip "${TOOLBOX64_TMP}/${package_source}" "${TOOLBOX64_TMP}" &&
    bl64_check_command "$package_installer_bin" ||
    return $?

  bl64_msg_show_task 'deploy application'
  bl64_fs_create_dir "$aws_mode" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$aws_root" &&
    bl64_fs_set_umask "$BL64_FS_UMASK_RW_USER_RO_ALL" &&
    "$package_installer_bin" \
      --install-dir "$aws_versions" \
      --bin-dir "$aws_bin" \
      --update &&
    bl64_check_command "$aws_cli" &&
    bl64_msg_show_info "Application file: ${aws_cli}" ||
    return $?

  bl64_msg_show_task "clean temporary files"
  bl64_fs_rm_file "${TOOLBOX64_TMP}/${package_source}"
  bl64_fs_rm_full "$package_installer"
  return 0
}

#
# Main
#

declare tb64_aws2_process='Install AWS CLI 2'
declare -i tb64_aws2_status=0

[[ -n "$TOOLBOX64_DEBUG" ]] && bl64_dbg_lib_enable
bl64_arc_setup &&
  bl64_check_privilege_root ||
  exit $?

bl64_msg_all_enable_verbose
bl64_msg_show_batch_start "$tb64_aws2_process"

tb64_aws2_provision
tb64_aws2_status=$?

bl64_fs_cleanup_full
bl64_msg_show_batch_finish "$tb64_aws2_status" "$tb64_aws2_process"
exit $tb64_aws2_status

#!/usr/bin/env bash

# shellcheck disable=SC1091
source "/toolbox64.env"  || exit 1
# shellcheck source=SCRIPTDIR/../../loader/bashlib64.bash disable=SC2154
source "${TOOLBOX64_LIB}/bashlib64.bash" || exit 1

#
# Variables
#

declare process='Install AWS CLI 2'
declare package_installer='aws'
declare package_installer_bin='aws/install'
declare package_source='awscli-exe-linux-x86_64.zip'
declare package_url='https://awscli.amazonaws.com'
declare aws_mode='0755'
declare aws_root='/opt/aws'
declare aws_bin='/opt/aws/bin'
declare aws_cli='/opt/aws/bin/aws'
declare aws_versions='/opt/aws/versions'
declare -i status=1

#
# Main
#

bl64_arc_setup &&
  bl64_os_match 'OL' ||
  exit $?

bl64_msg_all_enable_verbose
bl64_msg_show_batch_start "$process"

# shellcheck disable=SC2154
package_installer_bin="${TOOLBOX64_TMP}/${package_installer_bin}"
bl64_rxtx_web_get_file "${package_url}/${package_source}" "${TOOLBOX64_TMP}/${package_source}" &&
  bl64_arc_open_zip "${TOOLBOX64_TMP}/${package_source}" "${TOOLBOX64_TMP}" &&
  bl64_check_command "$package_installer_bin"
status=$?

if ((status == 0)); then
  bl64_msg_show_task "run AWS CLI package_installer (${package_installer_bin})"
  bl64_fs_create_dir "$aws_mode" "$BL64_LIB_DEFAULT" "$BL64_LIB_DEFAULT" "$aws_root" &&
    bl64_fs_set_umask "$BL64_FS_UMASK_RW_USER_RO_ALL" &&
    "$package_installer_bin" \
      --install-dir "$aws_versions" \
      --bin-dir "$aws_bin" \
      --update &&
    bl64_check_command "$aws_cli" &&
    bl64_msg_show_info "AWS CLI files installed under: ${aws_root}"
    bl64_msg_show_info "AWS CLI binaty file: ${aws_cli}"
  status=$?
fi

bl64_msg_show_task "clean temporary files"
[[ -f package_installer ]] && bl64_fs_rm_file "${TOOLBOX64_TMP}/${package_source}"
[[ -d package_installer ]] && bl64_fs_rm_full "$package_installer"

bl64_msg_show_batch_finish "$status" "$process"
exit $status

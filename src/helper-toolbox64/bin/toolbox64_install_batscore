#!/usr/bin/env bash

# shellcheck disable=SC1091
source "/toolbox64.env" || exit $?
# shellcheck source=SCRIPTDIR/../../loader/bashlib64.bash disable=SC2154
source "$TOOLBOX64_BASHLIB64" || exit $?

#
# Functions
#

tb64_bc_provision() {
  local repo="https://github.com/bats-core"
  local component_path="/opt"
  local component_name_core="bats-core"
  local component_name_support="bats-support"
  local component_name_assert="bats-assert"
  local component_name_file="bats-file"
  local component_path_helpers="${component_path}/${component_name_core}/test_helper"

  bl64_msg_show_task 'deploy application'
  bl64_fs_set_umask "$BL64_FS_UMASK_RW_USER_RO_ALL" &&
    bl64_vcs_git_clone "${repo}/${component_name_core}.git" "${component_path}" 'master' &&
    bl64_fs_mkdir_full "${component_path_helpers}" &&
    bl64_vcs_git_clone "${repo}/${component_name_support}.git" "${component_path_helpers}" 'master' &&
    bl64_vcs_git_clone "${repo}/${component_name_assert}.git" "${component_path_helpers}" 'master' &&
    bl64_vcs_git_clone "${repo}/${component_name_file}.git" "${component_path_helpers}" 'master' &&
    bl64_msg_show_info "Application file: ${component_path}/${component_name_core}"
}

#
# Main
#

declare tb64_bc_process='Install BatsCore'
declare -i tb64_bc_status=0

bl64_vcs_setup &&
  bl64_check_privilege_root ||
  exit $?

bl64_msg_all_enable_verbose
bl64_msg_show_batch_start "$tb64_bc_process"

tb64_bc_provision
tb64_bc_status=$?

bl64_fs_cleanup_full
bl64_msg_show_batch_finish "$tb64_bc_status" "$tb64_bc_process"
exit $tb64_bc_status

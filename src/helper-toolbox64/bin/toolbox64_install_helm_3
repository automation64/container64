#!/usr/bin/env bash

# shellcheck disable=SC1091
source "/toolbox64.env" || exit $?
# shellcheck source=SCRIPTDIR/../../loader/bashlib64.bash disable=SC2154
source "$TOOLBOX64_BASHLIB64" || exit $?

#
# Functions
#

tb64_hlm3_provision() {
  local package_installer='linux-amd64'
  local package_installer_bin="${package_installer}/helm"
  local package_source='helm-v3.11.0-linux-amd64.tar.gz'
  local package_url='https://get.helm.sh'
  local app_mode='0755'
  local app_root='/usr/local'
  local app_bin="${app_root}/bin"
  local app_cli="${app_bin}/helm"

  bl64_msg_show_task 'download application'
  # shellcheck disable=SC2154
  package_installer="${TOOLBOX64_TMP}/${package_installer}"
  package_installer_bin="${TOOLBOX64_TMP}/${package_installer_bin}"
  bl64_rxtx_web_get_file "${package_url}/${package_source}" "${TOOLBOX64_TMP}/${package_source}" &&
    bl64_arc_open_tar "${TOOLBOX64_TMP}/${package_source}" "${TOOLBOX64_TMP}" &&
    bl64_check_command "$package_installer_bin" ||
    return $?

  bl64_msg_show_task 'deploy application'
  bl64_fs_create_dir "$app_mode" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$app_root" "$app_bin" &&
    bl64_fs_copy_files "$app_mode" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$app_bin" "$package_installer_bin" &&
    bl64_check_command "$app_cli" &&
    bl64_msg_show_info "Application file: ${app_cli}" ||
    return $?

  bl64_msg_show_task "clean temporary files"
  bl64_fs_rm_full "$package_installer"

  return 0
}

#
# Main
#

declare tb64_hlm3_process='Install Helm 3'
declare -i tb64_hlm3_status=0

bl64_arc_setup &&
  bl64_check_privilege_root ||
  exit $?

bl64_msg_all_enable_verbose
bl64_msg_show_batch_start "$tb64_hlm3_process"

tb64_hlm3_provision
tb64_hlm3_status=$?

bl64_fs_cleanup_full
bl64_msg_show_batch_finish "$tb64_hlm3_status" "$tb64_hlm3_process"
exit $tb64_hlm3_status
